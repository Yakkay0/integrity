<!DOCTYPE HTML>
<!--
	Story by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Reto 2 Blockchain</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="assets/css/main.css" />
		
    <!-- Clase minando transacción -->
	<link rel="stylesheet" type="text/css" href="css/cargandoBlockchain.css">  
	
	</head>
	<body>
<div id="MinandoT">
		<!-- Wrapper -->
			<div id="wrapper" class="divided">
				<!-- Deshabilitar Funcionarios -->
				<section class="spotlight style1 orient-left content-align-left image-position-center onscroll-image-fade-in">
						<div  class="content">
						    <button id="BotonSalir">Salir</button>
							<h2>Deshabilitar funcionario</h2>
							<p>Deshabilite un funcionario para que no pueda subir el hash de un diploma a la blockchain.</p>
							<input id="cedula_deshabilitar" type="text" class="form-control" placeholder="Cédula del funcionario"><br>
							<button id="BotonDeshabilitar">Deshabilitar</button>
						</div>
						<div class="image">
							<img src="images/spotlight02.jpg" alt="" />
						</div>
					</section>
				<!-- Ver funcionarios -->
					<section class="spotlight style1 orient-right content-align-left image-position-center onscroll-image-fade-in" id="first">
						<div class="content">
								<h2>Ver cedulas funcionarios</h2>
								<p>Ver todas las cedulas de los funcionarios</p>
								<div class="margin-top-60">
										<div class=" col-md-4 "></div>
										<div id="cedulasFuncionarios"class="input-group col-md-4 text-center">
											Cédulas:
										</div>
										<div class=" col-md-4 "></div>
								<button onclick="mostrarFuncionarios()" type="submit" id="BotonMostrarFuncionarios">Ver funcionarios</button>
								</div>
						</div>
						<div class="image">
							<img src="images/spotlight01.jpg" alt="" />
						</div>
					</section>




				<!-- Habilitar funcionario -->
				<section class="spotlight style1 orient-left content-align-left image-position-center onscroll-image-fade-in">
						<div class="content">
							<h2>Habilitar funcionario</h2>
							<p>Habilitar un funcionario para que pueda subir el hash de un diploma a la blockchain.</p>
							<input id="cedula_permiso" type="text" class="form-control" placeholder="Cédula del funcionario"><br>
							<button id="BotonHabilitar">Habilitar</button>
						</div>
						<div class="image">
							<img src="images/spotlight02.jpg" alt="" />
						</div>
					</section>
				<!-- Ver funcionario -->
					<section class="spotlight style1 orient-right content-align-left image-position-center onscroll-image-fade-in" id="first">
						<div class="content">
								<h2>Ver Funcionario</h2>
								<p>Ver la información de un funcionario </p>
								<div class="margin-top-60">
										<div class=" col-md-4 "></div>
										<div class="input-group col-md-4 text-center">
										<input id="CedulaVerFuncionario" type="text" class="form-control" name="verFuncionario" placeholder="cedula"><br>
										</div>
										<div class=" col-md-4 "></div>
										<div id="mostrarFuncionario">
												Nombre:<br>
												Rol:<br>
												Estado:<br>.
										</div>
								<button onclick="mostrarFuncionario()" type="submit" id="BotonMostrarFuncionario">Ver funcionario</button>
								</div>
						</div>
						<div class="image">
							<img src="images/spotlight01.jpg" alt="" />
						</div>
					</section>

				<!-- Agregar Funcionario -->
					<section class="spotlight style1 orient-left content-align-left image-position-center onscroll-image-fade-in">
						<div class="content">							
							<h2>Agregar funcionario</h2>
							<p>Agregar un funcionario al sistema con rol Funcionario estándar o Director. El primero agrega hash de Diplomas mientras que el segundo puede agregar funcionarios</p>
							<div class="margin-top-60">      
									<div class=" col-md-4 "></div>
									<div class="input-group col-md-4 text-center">
									<input id="nueva_cedula" type="text" class="form-control" name="nueva_cedula" placeholder="nueva cedula"><br>
									<input id="nuevo_nombre" type="text" class="form-control" name="nuevo_nombre" placeholder="nuevo nombre"><br>
									<input id="nueva_contraseña" type="password" class="form-control" name="nueva_contraseña" placeholder="nueva contraseña"><br>
									<input id="nueva_rep_contraseña" type="password" class="form-control" name="nueva_contraseña" placeholder="repetir contraseña"><br>
								<!--	<input id="nuevo_rol" type="text" class="form-control" name="nuevo_rol" placeholder="nuevo rol"><br> -->
							<!--	<select id="nuevo_rol" class="selectpicker show-menu-arrow">
										<option value="2">Funcionario</option>
										<option value="3">Director</option>
									  </select> -->
									  <select id="selectnodo">
										<option value="3">Funcionario</option>
										<option value="2">Dirección</option>
									  </select>
									  
									Nuevo documento secreto<br><input id="nuevoDocSecreto"type="file" value="Agregar documento secreto">
								</div>
									<div class=" col-md-4 "></div>
									<br>
							<button id="BotonAgregarFuncionario">Agregar funcionario</button>
						  </div>
						</div>
						<div class="image">
							<img src="images/spotlight02.jpg" alt="" />
						</div>
					</section>

				<!-- Cambiar contraseña-->
				<!--
				<section class="spotlight style1 orient-right content-align-left image-position-center onscroll-image-fade-in" id="first">
						<div class="content">
								<h2>Cambiar contraseña</h2>
								<p>Introduzca su antigua contraseña y cambiela por una nueva</p>
								<div class="margin-top-60">
										<div class=" col-md-4 "></div>
										<div class="input-group col-md-4 text-center">
										<input id="antiguaContrasena" type="text" class="form-control" name="antiguaContrasena" placeholder="Antigua contraseña"><br>
										<input id="nuevaContrasena" type="text" class="form-control" name="nuevaContrasena" placeholder="Nueva contraseña"><br>
										<input id="verificarNuevaContrasena" type="text" class="form-control" name="verificarNuevaContrasena" placeholder="Repetir nueva contraseña"><br>
										</div>
										<div class=" col-md-4 "></div>
										<br>
								<button id="BotonCambiarContrasena">Cambiar contraseña</button>
							  </div>
						</div>
						<div class="image">
							<img src="images/spotlight01.jpg" alt="" />
						</div>
					</section>
                 -->

			</div>
</div>
		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			 <!-- libreria para calcular el hash md5 de un documento  -->
			 <script src="js/browser-md5-file.js"></script>

<!-- Ver funcionario-->			
<script>
	// cedula para consultar usuarios 
	var cedulainput1=null;
	// cedula para el permiso de los usuarios
	var cedula_permiso=null;
	// cedula para quitar permiso 
	var cedula_deshabilitar=null;
	//variables funcionario
	var sesion="";
    var rol="";
	var ceduladirector="";
	// tiempo de la transaccion
	var tiempotransaccion=null;
	//estado transaccion
	var estadox=null;

	//expresiones regulares para la validacion de parametros 
	var nombres=/[a-zA-Z áéíóúÁÉÍÓÚñÑ]/;
	var numeros = /^[0-9]+$/;
	 
	// variables de ingreso de usuarios 
	var nombre_ingr=null;
	var cedula_ing=null;
	var contraseña_ing="";
	var sum_md5=null;
	
	
	// metodo para busqueda documento_secreto
	$('#nuevoDocSecreto').bind('change', function (e) {
      console.log(e.target);
       var file = e.target.files[0];
       browserMD5File(file, function (err, md5) {
           sum_md5=md5;
         console.log(sum_md5); // 97027eb624f85892c69c4bcec8ab0f11
       });
     });
  

    
	// variables para la creación de funcionarios
//metodo mostran funcionarios 
function mostrarFuncionarios() {
	 //var cedulas = [1223452334,32142355567,543453456756,1233454456];
	 $.post("/direccion/mstrcdls/"+ceduladirector+'/'+sesion, function(res){
		 var cedulas=res.data9;
     var mostrarCedulas = 'Cédulas: <br>';
     for (var i = 0; i < cedulas.length; i++) {
      mostrarCedulas = mostrarCedulas + cedulas[i] + '<br>';
     }
     document.getElementById("cedulasFuncionarios").innerHTML = mostrarCedulas;
});
}
function mostrarFuncionario() {
	cedulainput1=$('#CedulaVerFuncionario').val();
	if(cedulainput1!=""){
		if(numeros.test(cedulainput1)){
	console.log(cedulainput1,ceduladirector,rol,sesion);
	//var nombre = "Yako Zuki";
	//var rol = 4+" Agrega hash de diplomas";
	$.post("/direccion/mstrfunc/"+cedulainput1+'/'+ceduladirector+'/'+sesion, function(res){
		var data1_nombre=res.data1;
		var data2_rol=res.data2;
		var data3_estado=res.data3;
		var rol_consulta="";
		if(data2_rol==3)
		{
			 rol_consulta="funcionario";
		}
		else if(data2_rol==2){
            rol_consulta="Director";  
		} else if(data2_rol==5){
			rol_consulta="retirado"; 
		}else {
			rol_consulta="no existe"; 
		}
		var estado_consulta="";
        if(data3_estado){
            estado_consulta="habilitado";
		}
		else {
            estado_consulta="deshabilitado"; 
		}
		document.getElementById("mostrarFuncionario").innerHTML = 'Nombre: '+data1_nombre+'<br>'+'Rol: '+rol_consulta+'<br>'+'Estado:'+estado_consulta;
          }); } else {
			alert("ingrese una cedula valida!");
		  }
}

else {
	alert("ingrese la cedula por favor!");
} }

/// proceso de hablilitar funcionario
$('#BotonHabilitar').on("click",function(){
	cedula_permiso=$('#cedula_permiso').val();
	if(cedula_permiso!=""){
		if(numeros.test(cedula_permiso)){
	console.log(cedula_permiso,ceduladirector,rol,sesion);
	$('#BotonHabilitar').attr("disabled", true);
	//var nombre = "Yako Zuki";
	//var rol = 4+" Agrega hash de diplomas";
	$.post("/direccion/cdlprqmso/"+cedula_permiso+'/'+ceduladirector+'/'+sesion, function(res){
		var tx_hab_func=res.data5;
		console.log(tx_hab_func);
          alert("se esta validando la habilitación del funcionario, verifique en 3 minutos");
		  $('#BotonHabilitar').attr("disabled", false);
          }); 
		}
		else {
			alert("ingrese una cedula valida!");
		  }

}
else {
	alert("ingrese la cedula por favor!");
}

});

// proceso para deshabilitar usuario
$('#BotonDeshabilitar').on("click",function(){
	cedula_deshabilitar=$('#cedula_deshabilitar').val();
	if(cedula_deshabilitar!=""){
		if(numeros.test(cedula_deshabilitar)){
		$('#BotonDeshabilitar').attr("disabled", true);
	console.log(cedula_deshabilitar,ceduladirector,rol,sesion);
	console.log("deshabilitar");
	//var nombre = "Yako Zuki";
	//var rol = 4+" Agrega hash de diplomas";
	$.post("/direccion/sincdlprqmso/"+cedula_deshabilitar+'/'+ceduladirector+'/'+sesion, function(res){
		var tx_hab_func=res.data4;
		console.log(tx_hab_func);
          alert("se esta validando la deshabilitación del funcionario, verifique en 3 minutos");
		  $('#BotonDeshabilitar').attr("disabled", false);
          }); }
		  else {
			alert("ingrese una cedula valida!");
		  }

}
else {
	alert("ingrese la cedula por favor!");
}

});
				
// proceso salir 
// proceso para deshabilitar usuario
$('#BotonSalir').on("click",function(){
	$('#BotonSalir').attr("disabled", true);
	$.post("/direccion/slousa/"+ceduladirector+'/'+sesion, function(res){
		document.getElementById("MinandoT").innerHTML = '<p style="color:white">.</p><p style="color:white">.</p><center><h3 style="color:grey">Generando transacción salir</h3><div class="MinandoTransaccion"></div></center>';
		var tx_salir=res.data7;
		console.log(tx_salir);
		tiempotransaccion= setInterval(()=> { //post de verificar minada transaccion
          $.post("/direccion/sltrxsl/"+tx_salir, function(res){
			estadox=res.data8;
               console.log(estadox);
               if(estadox==null){
		//Animación cargando         
		document.getElementById("MinandoT").innerHTML = '<p style="color:white">.</p><p style="color:white">.</p><center><h3 style="color:grey">Saliendo de la Blockchain</h3><div class="MinandoTransaccion"></div></center>';
 
                 console.log("esperando a minar la transacción");
               }
               else {
              console.log("La transacción ha sido minada!");
				clearInterval(tiempotransaccion);
				window.location.href="/ingresar";
			}
          }); 

},3000);
	})
});

// proceso para ver funcionarios 

$('#BotonAgregarFuncionario').on("click",function(){
var rol=$('#selectnodo').val();
cedula_ing= $('#nueva_cedula').val();	
contraseña_ing=$('#nueva_contraseña').val();
nombre_ingr=$('#nuevo_nombre').val();
 if (nombre_ingr!=="" && cedula_ing!=="" && sum_md5!== null && contraseña_ing!=="" ){
	if( nombres.test(nombre_ingr))
	{
	    	
		if(numeros.test(cedula_ing) && cedula_ing.length>5){
			if(contraseña_ing==$('#nueva_rep_contraseña').val()){
		$('#BotonAgregarFuncionario').attr("disabled", true);
		$.post("/direccion/ingfunc/"+ceduladirector+'/'+sesion+'/'+cedula_ing+'/'+contraseña_ing+'/'+sum_md5+'/'+nombre_ingr+'/'+rol , function(res){
          var tx_crea_func=res.data10;
		   console.log(tx_crea_func);
		  alert("se esta validando la creación del usuario, verifique en unos 3 minutos!");
		  $('#BotonAgregarFuncionario').attr("disabled", false);
          }); 
			   
			}
			else{
				alert("las contraseñas no son iguales!");
			}

			
		}
		else{
        alert("ingrese un numero de cedula valido!")
		}
	
	}
	else{
		alert("Ingrese un nombre valido!");
	} }
	else {
		console.log(cedula_ing,contraseña_ing,sum_md5,rol);
	    alert("ingrese todos los datos");
//	alert("se va agregar un funcionario!");
	}
});






// evento  para cargar las varibles que se envian desde el ingresar
				  window.onload = function() {
					sesion=localStorage.getItem('sesion');
					ceduladirector=localStorage.getItem('cedula');
					rol=localStorage.getItem('rol');
					console.log(sesion);
					
                };			
</script>
	</body>
</html>
